<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<title>工地管理</title>
	<link href="../../../../css/mui.css" rel="stylesheet" />
	<link href="../../../../css/layout.css" rel="stylesheet" />
</head>

<body>
<header class="mui-bar-nav mui-bar-transparent" style="display: none">
	<a class="mui-icon mui-icon-left-nav mui-pull-left" onclick="APIUtils.goBeforePage()"></a>
	<h1 class="mui-title">工地管理</h1>
</header>
<div style="height:10px;"></div>
<div class="mui-col-sm-8 mui-col-xs-8 fl">
	<div class="mui-input-row mui-search">
		<div type="search" onclick="searchSite()"><span class="mui-icon mui-icon-search"></span><span id="searchContent">搜索</span></div>
	</div>
</div>
<div class="mui-col-sm-4 mui-col-xs-4 fl mb15">
    <button value="查看全部" class="searchBtn" onclick="clickLoad()">查看全部</button>
</div>

<div class="dubellinelist">
    <ul id="siteDiv" style="padding-bottom: 42px;">
        <li id="siteLi" style="visibility:hidden">
            <div class="mui-col-sm-1 mui-col-xs-1 fl tc lineHeight44">
                1
            </div>
            <div class="mui-col-sm-7 mui-col-xs-7 fl">
                无
                <p>无</p>
                <p>状态:无</p>
            </div>

            <div class="mui-col-sm-2 mui-col-xs-2 fl tc lineHeight44">
                <a class="forange">总览</a>
            </div>
            <div class="mui-col-sm-2 mui-col-xs-2 fl tc lineHeight44">
                <a class="forange">详情</a>
            </div>
            <div class="clear"></div>
        </li>
    </ul>
</div>
<script id="siteDot" type="text/x-dot-template">
	{{ for(var x in it) { }}
	<li>
		<div class="mui-col-sm-1 mui-col-xs-1 fl tc lineHeight44">
			{{= it[x].No}}
		</div>
		<div class="mui-col-sm-7 mui-col-xs-7 fl">
			{{? it[x].name != null }} {{= it[x].name}} {{??}} &nbsp; {{?}}
			<p >施工单位:{{? it[x].constructionUnit != null }} {{= it[x].constructionUnit}} {{??}} &nbsp; {{?}}</p>
			<p>状态:{{? it[x].stateText != null }} {{= it[x].stateText}} {{??}} &nbsp; {{?}}</p>
		</div>

		<div class="mui-col-sm-2 mui-col-xs-2 fl tc lineHeight44">
			<a class="forange" onclick="jumpSitePandect('{{= it[x].id}}')">总览</a>
		</div>
		<div class="mui-col-sm-2 mui-col-xs-2 fl tc lineHeight44">
			<a class="forange" onclick="jumpSiteDetail('{{= it[x].id}}')">详情</a>
		</div>
		<div class="clear"></div>
	</li>
	{{ } }}
</script>
<script type="text/javascript" src="../../../../script/dot.min.js"></script>
<script type="text/javascript" src="../../../../script/api.js"></script>
<script type="text/javascript" src="../../../../script/js/APIUtils.js"></script>
<script type="text/javascript" src="../../../../script/js/business/business-project.js"></script>
<script type="text/javascript">
	// 数据加载参数（页码大小、页码起始页、搜索条件）
	var searchDataJson = {pageSize: 0, pageIndex: 0, searchData: [{}]};
	// 搜索参数
	var searchData = {projectName: "", projectId: "", constructionUnit: "", stateName: "", state: ""};

	apiready = function() {
		$api.fixStatusBar( $api.dom('header'));
		searchDataJson.pageSize = APIUtils.getPageSize(null, "siteLi");
		// 初始监听事件
		fnInitEvent();
		// 初始加载分页数据
		loadSite();
	};

	/**
	 * 搜索框设置查询条件
	 */
	function setSearch(str) {
		searchData = str;
		// 设置数据加载参数
		var searchJsonArr = new Array();
		searchJsonArr.push({"name":"eq_id", "value": searchData.projectId});
		searchJsonArr.push({"name":"like_constructionUnit", "value": searchData.constructionUnit});
        searchJsonArr.push({"name":"eq_state", "value": searchData.state});
		searchDataJson.searchData = searchJsonArr;
		// 清空之前条件查询的数据内容
		$api.dom('#siteDiv').innerHTML = "";
		// 根据搜索条件重新搜索
		searchDataJson.pageIndex = 0;
		// 根据搜索条件刷新数据
		loadSite();
	}
	/**
	 * 跳转工地总览
	 */
	function jumpSitePandect(id) {
		var idJson = {id: id};
		APIUtils.goToPageByWindow('sitePandect', '../detail/sitePandect.html', idJson);
	}
	/**
	 * 跳转工地详情
	 */
	function jumpSiteDetail(id) {
		var idJson = {id: id};
		APIUtils.goToPageByWindow('siteDetail', '../detail/siteDetail.html', idJson);
	}
	/**
	 * 跳转工地搜索frame框，输入查询工地条件
	 */
	function searchSite() {
		APIUtils.goToSearch('siteSearchForm', '../search/siteSearchForm.html', searchData);
	}
	/**
	 * 触发查询全部按钮
	 */
	function clickLoad() {
		// 清空搜索参数数据
        searchData = {projectName: "", projectId: "", constructionUnit: "", stateName: "", state: ""};
		// 清空查询条件
		searchDataJson.searchData = [{}];
		// 清空之前条件查询的数据内容
		$api.dom('#siteDiv').innerHTML = "";
		// 根据搜索条件重新搜索
		searchDataJson.pageIndex = 0;
		// 根据搜索条件刷新数据
		loadSite();
	}
	/**
	 * 加载工地数据
	 */
	function loadSite(isStart){
		APIUtils.showProgress("提示", "正在加载中....");
		projectModule.getProject(searchDataJson, function(ret, err) {
			APIUtils.hideProgress();
			// 判断请求是否错误
			if (!APIUtils.errorCatch(err)) {
				return;
			}
			var siteData = ret.data;
			if(siteData==null || siteData.length==0) {
				APIUtils.showToast("无更多数据加载",1000);
				return;
			}
			// 设置dom元素序号内容
			var no = searchDataJson.pageIndex*searchDataJson.pageSize+1;
			for (var i = 0; i < siteData.length; i++) {
				siteData[i].No = no+i;
			}
			// 数据页码加一
			searchDataJson.pageIndex++;
			var interText = doT.template($api.dom("#siteDot").innerHTML);
			if(isStart == false) {
				$api.append($api.dom('#siteDiv'),interText(siteData));
			} else {
				$api.dom('#siteDiv').innerHTML = interText(siteData);
			}
		});
	}
	/**
	 * 初始化页面监听事件
	 */
	function fnInitEvent(){
		/**上拉加载 */
		api.addEventListener({
			name:'scrolltobottom',
			extra:{
				threshold:10
			}
		}, function(ret, err){
			// 继续请求数据
			loadSite(false);
		});
		/** 下拉刷新 */
		api.setRefreshHeaderInfo({
			bgColor: '#ccc',
			textColor: '#fff',
			textDown: '下拉刷新...',
			textUp: '松开刷新...'
		}, function(ret, err) {
			searchDataJson.pageIndex = 0;
			// 刷新数据
			loadSite();
			// 取消下拉刷新效果
			api.refreshHeaderLoadDone();
		});
	}
</script>
</body>
</html>