<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<title>工地总览</title>
	<link href="../../../../css/mui.min.css" rel="stylesheet" />
	<link href="../../../../css/layout.css" rel="stylesheet" />
	<link href="../../../../css/home.css" rel="stylesheet" />
	<link href="../../../../css/sitePandect.css" rel="stylesheet" />
</head>
<body>
<header class="mui-bar-nav mui-bar-transparent dn">
	<a class="mui-icon mui-icon-left-nav mui-pull-left" onclick="APIUtils.goBeforePage()"></a>
	<h1 class="mui-title">工地总览</h1>
</header>
<div class="homebg">
	<div class="mui-content">
		<div class="mui-demo-container">
			<div class="mui-col-sm-4 mui-col-xs-4 fl" style="padding:20px 15px;">
				<p class="pl10 ">开工日期</p>
				<p class="fblue2" id="plannedStartTime"></p>
			</div>
			<div class="mui-col-sm-4 mui-col-xs-4 fr" style="padding:20px 15px;">
				<p class="pl10 ">竣工日期</p>
				<p class="fblue2" id="plannedCompletionTime"></p>
			</div>
			<div class="clear"></div>
			<div class="mybar" style="width: 87%;margin: 0 auto;">
				<!--动态改变这个值    width: 50%;-->
				<span style="width: 0%;" id="timeSchedule">0%</span>
			</div>
			<div class="chartbg flex-col h-center v-center" style="flex-direction: column;height:150px;">
				<p class="forange f18" id="projectCost">0</p>
				<p>工程造价</p>
				<p>(万元)</p>
			</div>
			<div class="mui-col-xs-3 mui-col-sm-3 fl chart">
				<div class="chartbg1 flex-col h-center v-center" style="flex-direction: column;">
					<p class="forange f26" id="logNum">0</p>
				</div>
				<div class="tc f12" style="margin-bottom:20px;">安全日志(篇)</div>
			</div>
			<div class="mui-col-xs-3 mui-col-sm-3 fl">
				<div class="chartbg2 flex-col h-center v-center" style="flex-direction: column;">
					<p class="forange f26" id="disclosuresNum">0</p>
				</div>
				<div class="tc f12" style="margin-bottom:20px;">安全交底(篇)</div>
			</div>
			<div class="mui-col-xs-3 mui-col-sm-3 fl">
				<div class="chartbg3 flex-col h-center v-center" style="flex-direction: column;">
					<p class="forange f26" id="rectifyNumBook">0</p>
				</div>
				<div class="tc f12" style="margin-bottom:20px;">整改通知书(份)</div>
			</div>
			<div class="mui-col-xs-3 mui-col-sm-3 fl">
				<div class="chartbg4 flex-col h-center v-center" style="flex-direction: column;">
					<p class="forange f26" id="checkNum">0</p>
				</div>
				<div class="tc f12" style="margin-bottom:20px;">安全检查(次)</div>
			</div>
			<div class="clear" style="height: 30px;"></div>
		</div>
	</div>
</div>
<div class="homelist" style="padding-bottom: 23px;">
	<ul class="">
		<li class="mui-media">
<!--			<div onclick="APIUtils.goToPageByWindow('hazardManagement', '../business/safety/hazardManagement.html', api.pageParam)">-->
		<div>
			<div class="mdiaico">
					<div class="img flex-col h-center v-center">
						<img src="../../../../image/war.png" width="36%">
					</div>
				</div>
				<div class="mui-media-body homelisttext">
					<p class="f18">危险源</p>
					<div class="mui-col-xs-4 mui-col-sm-4 fl">总数:<span id="dangerNum">0</span></div>
					<div class="mui-col-xs-4 mui-col-sm-4 fl">实施中:<span id="dangerInImplNum">0</span></div>
					<div class="mui-col-xs-4 mui-col-sm-4 fl">未实施:<span class="forange" id="dangerNotImplNum">0</span></div>
				</div>
			</div>
			<div class="clear"></div>
		</li>
		<li class="mui-media">
<!--			<div onclick="APIUtils.goToPageByWindow('safetyRectification', '../business/safety/safetyRectification.html', api.pageParam)">-->
			<div>
				<div class="mdiaico">
					<div class="img flex-col h-center v-center">
						<img src="../../../../image/bar.png" width="36%">
					</div>
				</div>
				<div class="mui-media-body homelisttext">
					<p class="f18">安全整改</p>
					<div class="mui-col-xs-4 mui-col-sm-4 fl">总数:<span id="rectifyNum">0</span></div>

					<div class="mui-col-xs-4 mui-col-sm-4 fl">未整改:<span class="forange" id="rectifyNotReNum">0</span></div>
				</div>
			</div>
			<div class="clear"></div>
		</li>
		<li class="mui-media">
<!--			<div onclick="APIUtils.goToPageByWindow('envMonitoring','../business/envMonitoring.html', api.pageParam)">-->
			<div>
				<div class="mdiaico">
					<div class="img flex-col h-center v-center">
						<img src="../../../../image/vedio.png" width="36%">
					</div>
				</div>
				<div class="mui-media-body homelisttext">
					<p class="f18">环境监测</p>
					<div class="mui-col-xs-4 mui-col-sm-4 fl">总数:<span id="envNum">0</span></div>

					<div class="mui-col-xs-4 mui-col-sm-4 fl">预警数:<span id="envWarnNum">0</span></div>
				</div>
			</div>
			<div class="clear"></div>
		</li>
		<li class="mui-media">
<!--			<div onclick="APIUtils.goToPageByWindow('videoMonitoring','../business/videoMonitoring.html', api.pageParam)">-->
			<div>
				<div class="mdiaico">
					<div class="img flex-col h-center v-center">
						<img src="../../../../image/leaf.png" width="36%">
					</div>
				</div>
				<div class="mui-media-body homelisttext">
					<p class="f18">视频监控</p>
					<div class="mui-col-xs-4 mui-col-sm-4 fl">总数:<span id="videoNum">0</span></div>
					<div class="mui-col-xs-4 mui-col-sm-4 fl">离线数:<span class="forange" id="videoOfflineNum">0</span></div>

				</div>
			</div>
			<div class="clear"></div>
		</li>
	</ul>
</div>
<!--<div style="padding-top: 20px;"></div>-->
<!--<script type="text/javascript" src="../../../../script/jquery-3.1.1.min.js"></script>-->
<!--<script type="text/javascript" src="../../../../script/mui.js"></script>-->
<script type="text/javascript" src="../../../../script/layout.js"></script>
<script type="text/javascript" src="../../../../script/api.js"></script>
<script type="text/javascript" src="../../../../script/js/APIUtils.js"></script>
<script type="text/javascript" src="../../../../script/js/business/business-project.js"></script>
<script>
	widthHeight("chartbg1","chartbg1");
	widthHeight("chartbg2","chartbg2");
	widthHeight("chartbg3","chartbg3");
	widthHeight("chartbg4","chartbg4");
	apiready = function() {
		$api.fixStatusBar( $api.dom('header'));
		var id = api.pageParam.id;
		initSite(id);
		initLog(id);
		initDisclosures(id);
		initRectify(id);
		initCheck(id);
		initDanger(id);
		initDevice(id);
	};

	/**
	 * 加载工地信息
	 * @param id
	 */
	function initSite(id){
		projectModule.getProjectDetail(id, function(ret, err) {
			// 判断请求是否错误
			if (!APIUtils.errorCatch(err)) {
				return;
			}
			var data = ret.object;
			// 设置dom元素内容
			var plannedStartTime = data.plannedStartTime;
			var plannedCompletionTime = data.plannedCompletionTime;
			// 定义时间百分比
			var timeSchedule = null;
			if(plannedStartTime != null && plannedCompletionTime != null){
				// timeSchedule = Math.round(((plannedCompletionTime - plannedStartTime) * 100) / plannedCompletionTime) + "%";
				var nowTime = new Date().getTime();
				timeSchedule = Math.round((nowTime - plannedStartTime) / (plannedCompletionTime - plannedStartTime) * 100) +"%";
				// 竣工日期小于当前时间
				if(plannedCompletionTime <= nowTime){
					timeSchedule = "100%";
				} else if(nowTime < plannedCompletionTime && timeSchedule == "100%") {
					// 当前时间小于竣工时间 并且 计算后结果为100的情况
					timeSchedule = "99%";
				}
				// 开工时间大于当前时间
				if(plannedStartTime > nowTime) {
					timeSchedule = "0%";
				} else if(plannedStartTime < nowTime && timeSchedule == "0%") {
					// 开工日期小于当前时间 并且 计算后结果为0的情况
					timeSchedule = "1%";
				}
			}
			$api.dom('#timeSchedule').innerHTML = timeSchedule == null ? "0%" : timeSchedule;
			document.getElementById('timeSchedule').style.width = timeSchedule == null ? "0%" : timeSchedule;
			$api.dom('#plannedStartTime').innerHTML = plannedStartTime == null ? "" : new Date(plannedStartTime).Format("yyyy-MM-dd");
			$api.dom('#plannedCompletionTime').innerHTML = plannedCompletionTime == null ? "" : new Date(plannedCompletionTime).Format("yyyy-MM-dd");
			$api.dom('#projectCost').innerHTML = data.projectCost == null ? "0" : data.projectCost;
		});
	}

	/**
	 * 加载安全日志信息
	 * @param id
	 */
	function initLog(id){
		projectModule.getLog(id, function(ret, err) {
			// 判断请求是否错误
			if (!APIUtils.errorCatch(err)) {
				return;
			}
			var data = ret.object;
			// 设置dom元素内容
			$api.dom('#logNum').innerHTML = data.logNum;
		});
	}

	/**
	 * 加载安全交底信息
	 * @param id
	 */
	function initDisclosures(id){
		projectModule.getDisclosures(id, function(ret, err) {
			// 判断请求是否错误
			if (!APIUtils.errorCatch(err)) {
				return;
			}
			var data = ret.object;
			// 设置dom元素内容
			$api.dom('#disclosuresNum').innerHTML = data.disclosuresNum;
		});
	}

	/**
	 * 加载安全整改信息
	 * @param id
	 */
	function initRectify(id){
		projectModule.getRectify(id, function(ret, err) {
			// 判断请求是否错误
			if (!APIUtils.errorCatch(err)) {
				return;
			}
			var data = ret.object;
			// 设置dom元素内容
            $api.dom('#rectifyNumBook').innerHTML = data.rectifyNum; //整改通知书
			$api.dom('#rectifyNum').innerHTML = data.rectifyNum;
			$api.dom('#rectifyNotReNum').innerHTML = data.rectifyNotReNum;
		});
	}

	/**
	 * 加载安全检查信息
	 * @param id
	 */
	function initCheck(id){
		projectModule.getCheck(id, function(ret, err) {
			// 判断请求是否错误
			if (!APIUtils.errorCatch(err)) {
				return;
			}
			var data = ret.object;
			// 设置dom元素内容
			$api.dom('#checkNum').innerHTML = data.checkNum;
		});
	}

	/**
	 * 加载危险源信息
	 * @param id
	 */
	function initDanger(id){
		projectModule.getDanger(id, function(ret, err) {
			// 判断请求是否错误
			if (!APIUtils.errorCatch(err)) {
				return;
			}
			var data = ret.object;
			// 设置dom元素内容
			$api.dom('#dangerNum').innerHTML = data.dangerNum;
			$api.dom('#dangerInImplNum').innerHTML = data.dangerInImplNum;
			$api.dom('#dangerNotImplNum').innerHTML = data.dangerNotImplNum;
		});
	}

	/**
	 * 加载设备信息
	 * @param id
	 */
	function initDevice(id){
		APIUtils.showProgress("提示", "正在加载中....");
		projectModule.getDevice(id, function(ret, err) {
			APIUtils.hideProgress();
			// 判断请求是否错误
			if (!APIUtils.errorCatch(err)) {
				return;
			}
			var data = ret.object;
			// 设置dom元素内容
			$api.dom('#envNum').innerHTML = data.envNum;
			$api.dom('#envWarnNum').innerHTML = data.envWarnNum;
			$api.dom('#videoNum').innerHTML = data.videoNum;
			$api.dom('#videoOfflineNum').innerHTML = data.videoOfflineNum;
		});
	}
</script>
</body>
</html>