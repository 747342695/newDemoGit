<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>视频监控-项目-视频列表</title>
    <!--<script src="../../script/jquery-3.1.1.min.js"></script>-->
    <!--<script src="../../../script/mui.js"></script>-->
    <link href="../../../../css/mui.css" rel="stylesheet"/>
    <link href="../../../../css/layout.css" rel="stylesheet"/>
    <link href="../../../../css/siteDetail.css" rel="stylesheet"/>
    <link href="../../../../css/index.css" rel="stylesheet"/>
    <link href="../../../../css/video.css" rel="stylesheet"/>
</head>

<body>
<header class="mui-bar-nav mui-bar-transparent" style="display: none">
    <a class="mui-icon mui-icon-left-nav mui-pull-left" onclick="APIUtils.goBeforePage()"></a>
    <h1 class="mui-title" id="myTitle">襄阳博物馆新馆</h1>
</header>
<div style="height:10px;"></div>
<div class="videolist">
    <ul id="videoData" style="margin-bottom:40px ">
        <li id="myLi" style="visibility: hidden">
            <div class="videoName fshadow">大门口视频
                <div onclick="openVideo({deviceCode:`{{= it[x].deviceCode}}`,deviceName:`{{= it[x].deviceName}}`})">
                    <div class="play flex-col v-center h-center">
                        <img src="../../../../image/videoplay.png"/>
                    </div>
                </div>
            </div>
        </li>
    </ul>
</div>
</body>

<script id="videoDataTemplate" type="text/x-dot-template">
    {{ for(var x in it) { }}
    <li>
        <div class="videoName fshadow">{{= it[x].deviceName}}
            <div onclick="openVideo({deviceNo: `{{= it[x].deviceNo}}`,deviceCode:`{{= it[x].deviceCode}}`,deviceName:`{{= it[x].deviceName}}`})">
                <div class="play flex-col v-center h-center">
                    <img src="../../../../image/videoplay.png"/>
                </div>
            </div>
        </div>
    </li>
    {{ } }}
</script>
<script src="../../../../script/api.js"></script>
<script src="../../../../script/dot.min.js" type="text/javascript"></script>
<script src="../../../../script/js/APIUtils.js"></script>
<script src="../../../../script/js/business/business-video.js"></script>
<script>
    var pageQueryDto = {pageIndex: 0, pageSize: 0, searchData: ''};
    // 存放获取的所有信息
    var pageData = new Array();
    // 用于记录总共视频数量
    var indexNum = 0;
    apiready = function () {
        $api.fixStatusBar($api.dom('header'));
        // 获取分页条目
        pageQueryDto.pageSize = APIUtils.getPageSize();
        $api.byId("myTitle").innerHTML = api.pageParam.projectName;
        // 设置分页查询条件
        pageQueryDto.searchData =[{name:"eq_projectId",value:api.pageParam.projectId},{name:"eq_deviceType",value:"0"},{name:"eq_isOnline",value:"0"}];
        fnInitEvent();// 初始监听事件
        pageQuery(pageQueryDto); // 查询分页数据
    };

    /**
     * 初始化页面监听事件
     */
    function fnInitEvent(){
        /**上拉加载 */
        api.addEventListener({
            name:'scrolltobottom',
            extra:{
                threshold:10
            }
        }, function(ret, err){
            //继续请求数据
            pageQuery(pageQueryDto, false);
        });
        /** 下拉刷新 */
        api.setRefreshHeaderInfo({
            bgColor: '#ccc',
            textColor: '#fff',
            textDown: '下拉刷新...',
            textUp: '松开刷新...'
        }, function(ret, err) {
            //重置页码、页面数据，请求数据
            pageQueryDto.pageIndex=0;
            pageQuery(pageQueryDto, true);
            // 取消下拉刷新效果
            api.refreshHeaderLoadDone();
        });
    };

    /**
     * 分页获取信息
     */
    function pageQuery(data, isStart) {
        APIUtils.showProgress('提示', '正在加载中');

        //查询项目分页查询
        videoModule.queryVideoList(data, function (ret, err) {
            APIUtils.hideProgress();
            if (!APIUtils.errorCatch(err)) {
                return;
            }
            if(ret.data==null || ret.data.length==0){
                APIUtils.showToast("无更多数据加载",1000);
                return;
            }
            // 存所有记录
            if (flag) {
                pageData = new Array();
                indexNum = 0;
            }
            var videoData = ret.data;
            for(var i=0; i<videoData.length; i++) {
                videoData[i].deviceNo = indexNum++;
                var vd = {deviceNo:videoData[i].deviceNo, deviceCode: videoData[i].deviceCode, deviceName: videoData[i].deviceName};
                pageData.push(vd);
            }
            var evaluation = doT.template($api.dom("#videoDataTemplate").innerHTML);
            var flag = isStart == undefined || isStart == null ? true : isStart;
            if (flag) {
                $api.dom('#videoData').innerHTML = evaluation(videoData);
            } else {
                $api.dom('#videoData').innerHTML += evaluation(videoData);
            }
            pageQueryDto.pageIndex++;
        });
    }

    /**
     * 打开海康威视UI模块
     */
    var module = null;
    // 当前直播预览序号
    var nowIndex = 0;
    function openVideo(data) {
        module = api.require('hkIvms');
        if (!module) {
            APIUtils.showToast("请添加模块后编译",2000);
            return;
        }
        module.login({
            address: 'https://61.184.202.35',
            username: 'admin',
            password: 'hik12345+@'
        }, function(ret, err) {
            if(!ret.status) {
                APIUtils.showToast("登录视频源失败", 2000);
                return;
            }
            // 监听控制台切换视频、截图事件
            liveEventListener(data);
            nowIndex = parseInt(data.deviceNo);
            // module.getRootControlCenter(function(ret, err){
            //     alert(JSON.stringify(ret)+" , "+JSON.stringify(err));
            // });
            // module.getSubResourceList({
            //     nodeType: 1,
            //     pid: 8
            // }, function(ret, err) {
            //     alert(JSON.stringify(ret)+" , "+JSON.stringify(err));
            // });
            module.openLiveUI({
                title: data.deviceName,
                sysCode: data.deviceCode,
                isShowControl: true,
                isShowQxd: true
            }, function(ret, err) {
                if(ret.status) {
                    openLiveAudio();
                } else {
                    // APIUtils.showToast("视频加载失败", 2000);
                }
            });
        });
    }

    /**
     * 监听UI模块的控制台事件
     */
    function liveEventListener(data) {
        // var dn = data.deviceNo;
        module.liveEventListener(function(ret, err) {
            if (ret.evenType == 'preBtnClick') {
                if(nowIndex-1 < 0){
                    APIUtils.showToast("已经是第一个视频了",2000);
                    return;
                }
                nowIndex--;
                module.switchLive({
                    index: nowIndex,
                    sysCode: pageData[nowIndex].deviceCode,
                    title: pageData[nowIndex].deviceName,
                    isShowControl: true,
                    isShowQxd: true
                }, function(ret1, err1) {
                    if(ret1.status) {
                        openLiveAudio();
                    }
                });
            } else if (ret.evenType == 'nextBtnClick') {
                if(nowIndex+1 >= indexNum){
                    APIUtils.showToast("已经是最后一个视频了",2000);
                    return;
                }
                nowIndex++;
                module.switchLive({
                    index: nowIndex,
                    sysCode: pageData[nowIndex].deviceCode,
                    title: pageData[nowIndex].deviceName,
                    isShowControl: true,
                    isShowQxd: true
                }, function(ret1, err1) {
                    if(ret1.status) {
                        openLiveAudio();
                    }
                });
            } else if (ret.evenType == 'capturePhoto') {
                // 保存截图
                api.saveMediaToAlbum({
                    path: ret.path
                }, function(ret, err) {
                    if (ret && ret.status) {
                        // APIUtils.showToast("保存成功", 2000);
                    } else {
                        // APIUtils.showToast("保存失败", 2000);
                    }
                });
            }
        });
    }

    /**
     * 打开摄像头声音
     */
    function openLiveAudio() {
        // 打开摄像头声音
        module.openLiveAudio(function(ret, err) {
            if(!ret.status) {
                // 开启延迟，避免与模块提示冲突
                // setTimeout(function(){
                //     APIUtils.showToast("音频加载失败",1500);
                // },2500);
            }
        });
    }

    /**
     * 关闭全屏直播预览
     */
    function closeLiveUI() {
        module = api.require('hkIvms');
        module.closeLiveUI(function (ret, err) {
            // 关闭直播预览成功
            if (ret["status"]) {
                // APIUtils.showToast("停止成功",1000);
            } else {
                // 当前没有直播预览则关闭当前window页面
                module.logout(function (ret, err) {
                    APIUtils.goBeforePage();
                });
            }
        });
    }

    /**
     * 从后台进入前台刷新全屏直播预览
     */
    function flushLiveUI() {
        module = api.require('hkIvms');
        module.switchLive({
            index: nowIndex,
            sysCode: pageData[nowIndex].deviceCode,
            title: pageData[nowIndex].deviceName,
            isShowControl: true,
            isShowQxd: true
        }, function(ret1, err1) {
            if(ret1.status) {
                openLiveAudio();
            }
        });
    }

    /**
     * 监听屏幕状态（横屏、竖屏切换）
     */
    window.onorientationchange = function(){
        if(window.orientation==90||window.orientation==-90){
            api.setFullScreen({
                fullScreen: true   //全屏显示
            });
        }else{
            api.setFullScreen({
                fullScreen: false
            });
        }
    }
</script>
</html>