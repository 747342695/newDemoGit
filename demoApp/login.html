<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>登录</title>
    <link rel="stylesheet" type="text/css" href="./css/api.css"/>
    <link rel="stylesheet" type="text/css" href="./css/mui.css"/>
    <link rel="stylesheet" type="text/css" href="./css/layout.css"/>
    <link rel="stylesheet" type="text/css" href="./css/login.css"/>
    <script type="text/javascript" src="script/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="script/api.js"></script>
    <script type="text/javascript" src="script/js/APIUtils.js"></script>
    <script type="text/javascript" src="script/js/login.js"></script>
    <script type="text/javascript" src="script/mui.js"></script>
</head>

<body>
<div class="login_bg">
    <div class="logo" style="text-align: center">
        <img src="image/hqwllogo.png"  >
    </div>
    <div class="logotext">
        仙桃建管通
    </div>

    <form id="login">
        <div class="login-input-group">
            <div class="mui-input-row" style="margin:10px 17%;padding:3px 0;border:1px solid #9fcbd9;border-radius:10px;">
                <label align="center" style="padding-left:0;padding-right:0;"><img src="image/user.png" style="width:20px;"/></label>
                <input type="text" class="mui-input-clear" name="username" id="username" placeholder="请输入用户名" style="height:46px;"/>
            </div>
            <div class="mui-input-row" style="margin:0 17%;padding:3px 0;border:1px solid #9fcbd9;border-radius:10px">
                <label align="center" style="padding-left:0;padding-right:0;"><img src="image/psw.png" style="width:20px;"/></label>
                <input type="password" class="mui-input-clear" name="password" id="password" placeholder="请输入密码" style="height:46px;" />
            </div>
        </div>
        <div align="center">
            <!-- <img src="image/loginbtn.png" style="position:relative;margin-top:-30%;width: 100%;height: 100%;" />-->
            <button type="button" class="login-btn" onclick="userLogin()" ></button>
        </div>
    </form>
</div>
<script type="text/javascript">
    //按钮定位
    var width=($(window).width()-120)*0.5;
    $('.login-btn').css({
        left:width+'px'
    });
    apiready = function () {
        APIUtils.listenEventView();
        // 获取缓存信息
        var loginInfo = $api.getStorage("loginInfo");
        if(loginInfo != null) {
            $api.byId("username").value = loginInfo.username;
            $api.byId("password").value = loginInfo.password;
        }
        // // 更新激光推送id
        // var ajpush = api.require('ajpush');
        // ajpush.getRegistrationId(function(ret) {
        //     alert("极光推送Id="+ret.id);
        //     console.log("极光推送id="+ret.id);
        //     var registrationId = ret.id;
        // });
        // ajpush.init(function (ret) {
        //     if (ret && ret.status) {
        //     //success
        //     }
        // });
    };

    // 隐藏按钮
    function hidebutton(){
        $('.login-btn').css({
            "display":"none",
        })
        $('.login_bg').css({
            "background":"none",
        })
    }
    // 显示按钮
    function showbutton(){
        $('.login-btn').css({
            "display":"block",
        })
        $('.login_bg').css({
            "background":"url(./image/loginbtnbg.png) no-repeat center bottom",
            "backgroundSize":"100% 55%"
        })
    }

    // 监听屏幕高度
    window.onresize = function () {
        if (document.body.scrollHeight < windowHeight) {
            hidebutton();
        } else {
            showbutton();
        }
    };

    // 点击登录事件
    function userLogin() {
        var username = $api.byId("username").value;
        var password = $api.byId("password").value;
        if (username == "" || username == null || username == undefined) {//非空判断
            APIUtils.showToast("用户名不能为空", 2000);
            return;
        }

        if (password == "" || password == null || password == undefined) {//非空判断
            APIUtils.showToast("密码不能为空", 2000);
            return;
        }
        // 定义账户信息对象
        var loginInfo = {username: username, password: password};
        // 判断当前账号是否跟缓存中的账号一致
        var localLoginInfo = $api.getStorage("loginInfo");
        if(localLoginInfo==null || (localLoginInfo.username != loginInfo.username || localLoginInfo.password != loginInfo.password)) {
            // 提示是否记住密码
            var btnArray = ['否', '是'];
            mui.confirm('是否记住密码', '提示', btnArray, function(e) {
                if (e.index == 1) {
                    $api.setStorage("loginInfo", loginInfo);
                }
                login(loginInfo);
            });
        } else login(loginInfo);
    }

    // 请求登录
    function login(loginInfo) {
        APIUtils.showProgress("提示", "正在登录中....");
        loginModule.login(loginInfo, function (ret, err) {
            APIUtils.hideProgress();
            //判断请求是否错误
            if (!APIUtils.errorCatch(err)) {
                return;
            }
            if (ret.msgcode == 1) {
                APIUtils.showToast(ret.msg, 3000);
                return;
            }
            ret.userId = JSON.parse(ret.userInfo)["userId"];
            ret.staffId = JSON.parse(ret.userInfo)["staffId"];
            ret.id = JSON.parse(ret.userInfo)["id"];
            $api.setStorage(KeyMap.CURRENT_USER, ret);
            $api.setStorage("demo", ret);
            // 更新激光推送id
            var ajpush = api.require('ajpush');
            ajpush.init(function (ret3, err) {
                if (ret3 && ret3.status) {
                    // success 获取激光推送id
                    ajpush.getRegistrationId(function(ret1, err1) {
                        var ajpushData = {userId: ret.id, registrationId: ret1.id};
                        // 更新用户激光推送id（f2字段）
                        loginModule.updateJPushRegisiterId(ajpushData, function(ret2, err2){
                            //判断请求是否错误
                            if (!APIUtils.errorCatch(err2)) {
                                // return;
                            }
                        });
                    });
                } else{
                    // APIUtils.showToast(err, 2000);
                }
            });
            // 关闭首页window页面
            api.closeWin({name: "index"});
            APIUtils.goToPageByWindow("index", "index.html");
        });
    }

</script>
</body>
</html>